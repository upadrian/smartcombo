/*
* Convierte un combo multiple en botones clickeables
* author: upadrian@gmail.com
* http://upadrian.github.com/smartcombo
*
* version 1.0.5 18/06/2012
*	
* 	bugfix y notas de la version:
*	-----------------------------
*		1.0.5
*			más bugfix(no selecciona el primer elemento cuando hay un elemento con selected="selected" desde el HTML). Agregado los comentarios
*		1.0.4.2
*			css fixed en theme/pela
*			br remove en el armado html
*		1.0.4.1
*			Para un selector que refiera a varios elementos, los tomaba como uno solo. Por ejemplo $("#select1,#select2")
*			
*		1.0.4
*			Revisado el rendimiendo. Ahora se cachean las consultas al DOM. Se eliminan variables sin usar. TODO: resolver el
*			pie "seleccionar todos / ninguno" de los combos multiples y multiples con optgroups
*		1.0.3
*			bug en chrome, no dejaba de-seleccionar una opcion, en un combo multiple y en un combo multiple con optgroup
*		1.0.2
*			En un select simple, al seleccionar un elemento por primera vez, estando anteriormente seleccionado 
*			el elemento superior, no actualizaba el valor seleccionado en el select. M?todo: updateSelect
*
*
*/
(function(a){a.fn.smartCombo=function(b){var d={};var e={init:function(b){if(a(this).length>1)a(this).each(function(){a(this).smartCombo(b)});else e.sc_init(a(this),b)},sc_init:function(b,c){b.data("initDone",false);d.sourceJQO=b;d.sourceNode=d.sourceJQO.get(0);var f={_class:"sc",_text_labelSimple:"Seleccione una opción",_text_labelMultiple:"Seleccione opciones",_open:false,_wrapperPosition:"absolute",_closeOnClick:true,_openOnMouseEnter:false,_closeOnMouseLeave:true,reArmOnLoad:true,setAllSelectedTofalse:false,_initialState:"close"};d.settings=a.extend(f,c);d.props={multiple:d.sourceJQO.attr("multiple")?true:false,destID:"sc_"+d.sourceJQO.attr("id"),_ulClass:d.settings._class+"_ul",_liClass:d.settings._class+"_li",_labelClass:d.settings._class+"_label",_footerDivClass:d.settings._class+"_footer",_footerAbt:d.settings._class+"_footerBT",_footerBTall:d.settings._class+"_footerBTall",_footerBTnone:d.settings._class+"_footerBTnone",_liClassOptGroup:d.settings._class+"_optGroup",_liClassOptGroupLabel:d.settings._class+"_optGroupLabel",_wrapperClass:d.settings._class+"_wrapper",_optionSelectedClass:d.settings._class+"_optionSelectedClass",_optgroupSelectedClass:d.settings._class+"_optgroupSelectedClass"};var g="";g+='<div id="'+d.props.destID+'" class="'+d.settings._class+'">';g+='	<div class="'+d.props._labelClass+'">';g+='		<a href="javascript:;" title="'+(d.props.multiple?d.settings._text_labelMultiple:d.settings._text_labelSimple)+'">'+(d.props.multiple?d.settings._text_labelMultiple:d.settings._text_labelSimple)+"</a>";g+="	</div>";g+='	<div class="'+d.props._wrapperClass+'" style="position:'+d.settings._wrapperPosition+'">';g+='		<ul class="'+d.props._ulClass+'">';d.sourceJQO.children("optgroup,option").each(function(){g+=e.getNode(a(this))});g+="		</ul>";g+="	</div>";g+="</div>";d.sourceJQO.css("display","none").after(g);d.sc=a("#"+d.props.destID);d.sc_options=a("."+d.props._liClass+" a",d.sc);d.sc_label=a("."+d.props._labelClass+" a",d.sc);d.sc_optgroups=a("."+d.props._liClassOptGroup+" a",d.sc);d.sc_optgroups_labels=a("."+d.props._liClassOptGroupLabel,d.sc);d.wrapper=a("."+d.props._wrapperClass,d.sc);d.hasOptgrups=a("optgroup",d.sourceJQO).length>0?true:false;d.optgroups=a("optgroup",d.sourceJQO);d.options=a("option",d.sourceJQO);e.setActions()},getNode:function(b){var c="",f=b.get(0);if(f.tagName=="OPTGROUP"){c+='<li class="'+d.props._liClassOptGroup+'">';if(d.props.multiple)c+='	<a href="javascript:;" class="'+d.props._liClassOptGroupLabel+'" title="'+b.attr("label")+'">'+b.attr("label")+"</a>";else c+='	<span class="'+d.props._liClassOptGroupLabel+'" >'+b.attr("label")+"</span>";c+="	<ul>";b.children("option").each(function(){c+=e.getNode(a(this))});c+="	</ul>";c+="</li>"}else{c+='<li class="'+d.props._liClass+'" val="'+b.val()+'">';c+='	<a href="javascript:;" inheritedValue="'+b.val()+'" index="'+f.index+'">';c+="		<span>";c+=b.html();c+="		</span>";c+="	</a>";c+="</li>"}return c},setActions:function(){d.sc_label.click(function(){if(d.settings._closeOnClick)d.settings._open=d.settings._open?e.closeWrapper():e.openWrapper()});d.sc_options.click(function(){e.clickOnOption(a(this))});if(d.props.multiple){d.sc_optgroups_labels.click(function(){e.clickOnOptGroup(a(this).parent())})}e.setEvents()},setEvents:function(){if(d.settings._openOnMouseEnter)d.sc.bind("mouseenter",function(){d.settings._open=e.openWrapper()});if(d.settings._closeOnMouseLeave&&d.settings._closeOnClick)d.sc.bind("mouseleave",function(){d.settings._open=e.closeWrapper()});e.reArmFromSource();if(d.settings._initialState=="open")e.openWrapper()},destroy:function(){return this.each(function(){var b=a(this),c=b.data("smartCombo");b.removeData("smartCombo")})},populateLabels:function(){var b=[];a("."+d.props._optionSelectedClass+" span",d.sc).each(function(){b.push(a(this).html())});d.sc.data("labels",b);var c=b.join(", ");if(c=="")c=d.props.multiple?d.settings._text_labelMultiple:d.settings._text_labelSimple;d.sc_label.html(c)},reArmFromSource:function(){try{console.debug("rearmFromSource")}catch(b){}var c=[];for(vi=0;vi<d.sourceNode.options.length;vi++)if(d.sourceNode.options.item(vi).selected)c.push(String(vi));d.sc_options.each(function(){if(jQuery.inArray(a(this).attr("index"),c)!=-1)a(this).addClass(d.props._optionSelectedClass);else a(this).removeClass(d.props._optionSelectedClass)});d.sc_optgroups.each(function(){var b=a(this);ok=true;a("."+d.props._liClass+" a",b).each(function(){if(!a(this).hasClass(d.props._optionSelectedClass))ok=false});if(ok)b.data("seleccionado",true).children("a").addClass(d.props._optgroupSelectedClass);else b.data("seleccionado",false).children("a").removeClass(d.props._optgroupSelectedClass)});if(!d.props.multiple&&d.settings._closeOnClick)d.settings._open=e.closeWrapper();e.populateLabels()},clickOnOptGroup:function(b){if(b.data("seleccionado")){a("."+d.props._liClass+" a",b).removeClass(d.props._optionSelectedClass);b.data("seleccionado",false).children("a").removeClass(d.props._optgroupSelectedClass)}else{a("."+d.props._liClass+" a",b).addClass(d.props._optionSelectedClass);b.data("seleccionado",true).children("a").addClass(d.props._optgroupSelectedClass)}e.populateLabels();e.updateSelect()},updateSelect:function(){var b=[];d.sc_options.each(function(){if(a(this).hasClass(d.props._optionSelectedClass))b.push(a(this).attr("index"))});for(c=0;c<d.sourceNode.options.length;c++)d.sourceNode.options.item(c).selected=jQuery.inArray(String(c),b)!=-1?true:false;e.reArmFromSource();d.sourceJQO.change()},openWrapper:function(){d.wrapper.css("display","block");return true},closeWrapper:function(){d.wrapper.css("display","none");return false},clickOnOption:function(b){if(!d.props.multiple){d.sc_options.removeClass(d.props._optionSelectedClass);if(d.settings._closeOnClick)d.settings._open=e.closeWrapper()}if(b.hasClass(d.props._optionSelectedClass))b.removeClass(d.props._optionSelectedClass);else b.addClass(d.props._optionSelectedClass);var c=b.parent().parent().parent();if(c.length>0){var f=true;a("."+d.props._liClass+" a",c).each(function(){if(!a(this).hasClass(d.props._optionSelectedClass))f=false});if(f)c.data("seleccionado",true).children("a").addClass(d.props._optgroupSelectedClass);else c.data("seleccionado",false).children("a").removeClass(d.props._optgroupSelectedClass)}e.populateLabels();e.updateSelect()}};if(e[b])return e[b].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof b==="object"||!b)return e.init.apply(this,arguments);else a.error("Method "+b+" does not exist on jQuery.smartCombo")}})(jQuery)